# 设备报警





## 问题描述

对一个设备的多个信号进行异常报警。



**前提：假设所有数据大于0都需要报警**



-   设备1的数据生产时间记录表

| 设备信号 | 设备数据 | 数据生产时间           | 数据到服务端顺序 |
| -------- | -------- | ---------------------- | ---------------- |
| A1       | 1        | 2023年04月25日00:00:00 | 1                |
| A2       | 1        | 2023年04月25日00:00:00 | 3                |
| A3       | 1        | 2023年04月25日00:00:00 | 2                |
| A1       | 1        | 2023年04月25日00:00:01 | 4                |
| A2       | 1        | 2023年04月25日00:00:01 | 5                |
| A3       | 1        | 2023年04月25日00:00:01 | 6                |
|          |          |                        |                  |

-   报警规则

A1、A2、A3中只要有一个数据异常然后开始计时10秒，若十秒内还有其他任意一个信号报警则表示需要报警。暂定规则唯一标识为`rule_1`

在上述数据情况下核心处理流程如下。

1.   根据设备唯一标识找到所有关联的报警规则

2.   在第一步找到的报警规则中过滤需要和A1信号交互的规则，此时应该找到`rule_1`

3.   找到`rule_1`以后有两种情况：

     1.   Rule_1是第一次触发，
          1.   记录这样一个信息：`设备1@rule_1` 触发次数1
     2.   rule_1不是第一次触发
          1.   记录这样一个信息：`设备1@rule_1` 触发次数累加1

     总结，设备规则计数器：

     ```
     {
     "id":"唯一标识",
        "uid"："设备唯一标识+@+规则唯一标识",
        "count":"次数",
        "rule_id":"规则id",
     }
     ```

     设备计数器有效时间

     ```
     {
     "rule_id":"规则id",
      "uid"："设备规则计数器唯一标识"
      "start_time":"开始时间",
      "end_time":"结束时间"
     }
     ```

     

4.   当完成第三步操作后应该得到触发次数（pems），配合这个次数应该再记录如下信息

     `设备1@rule_1@pems`，值为具体的设备信号数据

     注意这个键是有过期时间的，过期时间为数据生产时间+十秒(信号内最大数值)

     当这个键过期后则执行报警逻辑





注意如果在两个时间节点中信号分别产生数据则需要做两条报警。即

1.   信号A第一秒产生数据，它能够管理的时间范围是第一秒到第十秒
2.   信号A第二秒产生数据，它能够管理的时间范围是第二秒到第十秒

综上所述在报警规则中应该要有一个主信号，根据这个主信号做时间分片。

### 数据模拟

1.   这条数据推送A1  1  2023年04月25日00:00:00  此时数据信息如下

```
// 设备规则计数器
{
"id":"1",
   "uid"："设备1@rule_1",
   "count":"1"
   "rule_id":"rule_1",
}

// 设备计数器有效时间
{
"rule_id":"rule_1",
 "uid"："1",
 "start_time":"2023年04月25日00:00:00",
 "end_time":"2023年04月25日00:00:10"
}

```



2.   这条数据推送A3  1  2023年04月25日00:00:00  

根据搜索规则会找到rule_1报警规则，根据A3的时间序列信息应该找到设备计数器有效时间的信息如下

```
{
"rule_id":"rule_1",
 "uid"："1",
 "start_time":"2023年04月25日00:00:00",
 "end_time":"2023年04月25日00:00:10"
}
```

找到后根据上述对象的uid找到设备规则计数器中存储的计数器。

3.   这条数据推送 A2  1  2023年04月25日00:00:00，执行行为和（2）一样
4.   这条数据推送A1  1  2023年04月25日00:00:01

根据搜索规则会找到rule_1报警规则，根据A1的时间序列信息，由于这是一个主体信号此时应该产生另有一个设备规则计数器

```
// 设备规则计数器
{
"id":"2",
   "uid"："设备1@rule_1",
   "count":"2"
   "rule_id":"rule_1",
}

// 设备计数器有效时间
{
"rule_id":"rule_1",
 "uid"："2",
 "start_time":"2023年04月25日00:00:01",
 "end_time":"2023年04月25日00:00:11"
}

```

