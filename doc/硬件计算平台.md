# 硬件计算平台

设计目标：

1.   硬件基础数据存储、统一存储硬件数据，为后续计算做存储服务
2.   硬件计算模块
3.   硬件数据展示模块



## 硬件基础数据存储（统一存储硬件数据）

将硬件数据分为如下五种：

1.   设备详情：用于存储每个硬件设备的详细信息，包括设备名称、地址、坐标等基本信息，以及硬件类型id集合、硬件扩展信息等其他相关信息。该模块允许用户对设备信息进行增删改查操作。
2.   硬件扩展信息：用于存储硬件设备的扩展信息，例如供应商提供的设备id等。
3.   硬件类型信号表：用于存储不同硬件类型所对应的信号信息，包括信号名称、最小值、最大值、默认告警小区间、默认告警大区间等
4.   硬件信号映射关系表：用于记录硬件输出信号和系统指定的信号名称之间的关系。
5.   硬件类型表：用于存储不同硬件类型的基本信息，包括硬件类型名称、设备类型编码以及硬件信号列表等。





### 功能流程设计

1.  设备详情管理

    -   添加设备信息：用户可以通过界面输入所需的设备信息，例如设备名称、地址、坐标等基本信息，以及硬件类型id集合、硬件扩展信息等其他相关信息。系统会将这些信息存储到设备详情表中，并为该设备生成唯一的对象标识符。

    -   查看设备信息：用户可以在设备列表页面上查看所有已经添加的设备信息，查询结果按照设备名称或者设备类型进行排序。

    -   修改设备信息：用户可以编辑已有的设备信息，例如修改设备名称、地址、坐标等基本信息，以及修改硬件类型id集合、硬件扩展信息等其他相关信息。

    -   删除设备信息：用户可以删除不需要的设备信息，删除操作将导致系统将该设备标记为已删除状态。

2.  硬件扩展信息管理

    -   添加硬件扩展信息：用户可以通过界面输入所需的硬件扩展信息，例如供应商提供的设备id等。系统会将这些信息存储到硬件扩展信息表中，并为其生成唯一的对象标识符。

    -   查看硬件扩展信息：用户可以在硬件扩展信息列表页面上查看所有已经添加的硬件扩展信息，查询结果按照设备id进行排序。

    -   修改硬件扩展信息：用户可以编辑已有的硬件扩展信息，例如修改设备id等。

    -   删除硬件扩展信息：用户可以删除不需要的硬件扩展信息，删除操作将导致系统将该硬件扩展信息标记为已删除状态。

3.  硬件类型信号管理

    -   添加硬件类型信号：用户可以通过界面输入所需的硬件类型信号信息，例如信号名称、最小值、最大值、默认告警小区间、默认告警大区间等。系统会将这些信息存储到硬件类型信号表中，并为每个硬件类型信号生成唯一的对象标识符。

    -   查看硬件类型信号：用户可以在硬件类型信号列表页面上查看所有已经添加的硬件类型信号，查询结果按照信号名称进行排序。

    -   修改硬件类型信号：用户可以编辑已有的硬件类型信号，例如修改信号名称、最小值、最大值、默认告警小区间、默认告警大区间等信息。

    -   删除硬件类型信号：用户可以删除不需要的硬件类型信号，删除操作将导致系统将该硬件类型信号标记为已删除状态。

4.  硬件信号映射关系管理

    -   添加硬件信号映射关系：用户可以通过界面选择某个硬件设备以及其对应的硬件类型信号，在系统中建立硬件信号和系统指定信号名称之间的映射关系。系统会将这些信息存储到硬件信号映射关系表中，并为每个硬件信号映射关系生成唯一的对象标识符。

    -   查看硬件信号映射关系：用户可以在硬件信号映射关系列表页面上查看所有已经添加的硬件信号映射关系，查询结果按照设备名称或者信号名称进行排序。

    -   修改硬件信号映射关系：用户可以编辑已有的硬件信号映射关系，例如修改硬件输出信号key、系统指定信号名称等信息。

    -   删除硬件信号映射关系：用户可以删除不需要的硬件信号映射关系，删除操作将导致系统将该硬件信号映射关系标记为已删除状态。

5.  硬件类型管理

    -   添加硬件类型：用户可以通过界面输入所需的硬件类型信息，例如硬件类型名称、设备类型编码以及硬件信号列表等。系统会将这些信息存储到硬件类型表中，并为每个硬件类型生成唯一的对象标识符。

    -   查看硬件类型：用户可以在硬件类型列表页面上查看所有已经添加的硬件类型，查询结果按照硬件类型名称或者设备类型编码进行排序。

    -   修改硬件类型：用户可以编辑已有的硬件类型，例如修改硬件类型名称、设备类型编码以及硬件信号列表等信息。

    -   删除硬件类型：用户可以删除不需要的硬件类型，删除操作将导致系统将该硬件类型标记为已删除状态。



### 存储结构

1.  设备详情管理

    -   设备详情是系统中核心的数据对象之一，它记录了每个硬件设备的详细信息。在设计时，可以将设备详情分为两个表：设备详情表和设备类型关联表。

    -   设备详情表用于存储每个硬件设备的基本信息，例如设备名称、地址、坐标等。同时，该表还包括typeIds字段，用于记录一个硬件设备所对应的所有硬件类型标识符。这样设计可以方便地查询某个硬件设备所能够产生的所有信号。

    -   设备类型关联表用于记录设备详情表和硬件类型表之间的关系。该表包括deviceId和typeId两个字段，分别表示设备详情表中的设备ID和硬件类型表中的硬件类型ID。通过该表，系统可以方便地查询某个设备所对应的所有硬件类型。

1.  硬件类型管理

    -   硬件类型是定义硬件信号的关键概念之一。在设计时，可以将硬件类型分为三个表：硬件类型表、硬件类型信号表和硬件类型信号关联表。

    -   硬件类型表用于存储不同硬件类型的基本信息，例如硬件类型名称、设备类型编码等。同时，该表还包括signalIds字段，用于记录一个硬件类型所对应的所有硬件信号标识符。这样设计可以方便地查询某个硬件类型所能够产生的所有信号。

    -   硬件类型信号表用于存储不同硬件类型所对应的信号信息，例如信号名称、最小值、最大值、默认告警小区间、默认告警大区间等。通过该表，系统可以方便地查询某个硬件类型所定义的所有信号信息。

    -   硬件类型信号关联表用于记录硬件类型表和硬件类型信号表之间的关系。该表包括typeId和signalId两个字段，分别表示硬件类型表中的硬件类型ID和硬件类型信号表中的硬件信号ID。通过该表，系统可以方便地查询某个硬件类型所对应的所有硬件信号。

1.  硬件信号映射关系管理
    -   硬件信号映射关系表用于记录硬件输出信号和系统指定信号名称之间的关系。在设计时，该表包括deviceId、signalKey和systemSignalName三个字段，分别表示硬件设备ID、硬件输出信号key和系统指定信号名称。通过该表，系统可以方便地将收到的硬件信号转换为统一的系统信号，以便后续的数据处理和分析。

1.  硬件扩展信息管理
    -   硬件扩展信息表用于存储硬件设备的扩展信息，例如供应商提供的设备id等。该表包括deviceId和extInfo两个字段，分别表示硬件设备ID和扩展信息。通过该表，系统可以方便地记录和查询每个硬件设备的扩展信息。
    -   通过以上设计和实现，我们可以方便地管理各类硬件设备信息，并为后续的硬件计算和分析提供有力支持。同时，该功能架构也能够灵活适应不同硬件类型和供应商提供的硬件信号变化，保证了系统的可扩展性和稳定性。

#### 设备详情表（device_detail）

| 字段名称   | 字段类型 | 字段说明       |
| ---------- | -------- | -------------- |
| id         | int      | 设备详情表主键 |
| name       | varchar  | 设备名称       |
| address    | varchar  | 设备地址       |
| latitude   | float    | 设备所在纬度   |
| longitude  | float    | 设备所在经度   |
| createTime | datetime | 记录创建时间   |
| updateTime | datetime | 记录更新时间   |

#### 设备类型关联表（device_type_relation）

| 字段名称 | 字段类型 | 字段说明                 |
| -------- | -------- | ------------------------ |
| id       | int      | 关系主键                 |
| deviceId | int      | 设备详情表中的设备ID     |
| typeId   | int      | 硬件类型表中的硬件类型ID |

#### 硬件类型表（hardware_type）

| 字段名称   | 字段类型 | 字段说明       |
| ---------- | -------- | -------------- |
| id         | int      | 硬件类型表主键 |
| name       | varchar  | 硬件类型名称   |
| code       | varchar  | 设备类型编码   |
| createTime | datetime | 记录创建时间   |
| updateTime | datetime | 记录更新时间   |

#### 硬件信号标识符表（hardware_signal）

| 字段名称        | 字段类型 | 字段说明             |
| --------------- | -------- | -------------------- |
| id              | int      | 硬件信号标识符表主键 |
| name            | varchar  | 信号名称             |
| minValue        | float    | 信号最小值           |
| maxValue        | float    | 信号最大值           |
| defaultWarnLow  | float    | 默认告警小区间       |
| defaultWarnHigh | float    | 默认告警大区间       |
| createTime      | datetime | 记录创建时间         |
| updateTime      | datetime | 记录更新时间         |

#### 硬件类型信号关联表（hardware_type_signal）

| 字段名称 | 字段类型 | 字段说明                       |
| -------- | -------- | ------------------------------ |
| id       | int      | 关系主键                       |
| typeId   | int      | 硬件类型表中的硬件类型ID       |
| signalId | int      | 硬件信号标识符表中的硬件信号ID |

#### 硬件信号映射关系表（hardware_signal_mapping）

| 字段名称         | 字段类型 | 字段说明               |
| ---------------- | -------- | ---------------------- |
| id               | int      | 硬件信号映射关系表主键 |
| deviceId         | int      | 硬件设备ID             |
| signalKey        | varchar  | 硬件输出信号key        |
| systemSignalName | varchar  | 系统指定信号名称       |
| createTime       | datetime | 记录创建时间           |
| updateTime       | datetime | 记录更新时间           |

#### 硬件扩展信息表（hardware_extension_info）

| 字段名称   | 字段类型 | 字段说明           |
| ---------- | -------- | ------------------ |
| id         | int      | 硬件扩展信息表主键 |
| deviceId   | int      | 硬件设备ID         |
| extInfo    | varchar  | 扩展信息           |
| createTime | datetime | 记录创建时间       |
| updateTime | datetime | 记录更新时间       |

#### 硬件类型信号标识符关联表（hardware_type_signal_identifier）

| 字段名称 | 字段类型 | 字段说明                       |
| -------- | -------- | ------------------------------ |
| id       | int      | 关系主键                       |
| typeId   | int      | 硬件类型表中的硬件类型ID       |
| signalId | int      | 硬件信号标识符表中的硬件信号ID |



## 硬件信号信息存储

硬件方推送数据的技术处理流程

1.   硬件向本系统提供的 HTTP 接口发送请求：硬件通过自身的传感器采集数据，并将数据通过 HTTP 协议发送给本系统。在发送数据之前，需要保证数据格式的正确性和数据的完整性。可以使用 JSON 或其他标准数据格式进行数据传输。
2.   本系统接收到请求后将数据放入消息队列：本系统接收到硬件发送的请求后，将数据放入消息队列中。本项目消息队列选择Kafka
3.   消息消费者将数据进行落地存储：消息队列中的数据由消息消费者进行消费和处理，将数据进行落地存储。本系统采用Mongo做数据存储

本系统定时拉取硬件平台提供的数据：

1.   和硬件供应商提供的接口进行对接：本系统需要和硬件供应商进行接口对接，以便于获取硬件平台提供的数据。可以通过 HTTP、WebSocket、MQTT 等协议进行通信，需要保证数据传输的安全性和可靠性。
2.   拉取一定时间范围内的数据：定时拉取数据需要指定拉取的时间范围，例如以分钟、小时、天为单位进行拉取。在拉取数据的过程中，需要注意数据是否正常获取，如果出现数据缺失或异常情况，需要有相应的补偿机制进行处理。
3.   将拉取的数据放入消息队列，本项目消息队列选择Kafka
4.   消息消费者将数据进行落地存储：消息队列中的数据由消息消费者进行消费和处理，将数据进行落地存储。本系统采用Mongo做数据存储





-   数据存储结构

| 字段名     | 数据类型 | 说明                                                |
| ---------- | -------- | --------------------------------------------------- |
| id         | String   | 数据存储记录的唯一标识符                            |
| deviceType | String   | 设备类型标识符，用于区分不同类型设备产生的数据      |
| deviceId   | String   | 设备ID，用于区分同一类型设备中不同设备产生的数据    |
| key        | String   | 硬件信号标识符，表示该条数据对应的硬件信号名称或 ID |
| value      | String   | 数据值，表示该条数据对应的硬件信号的数值            |
| time       | long     | 时间戳，表示该条数据对应的采集时间                  |





## 硬件信号计算

核心处理流程：

1.   配置计算规则
2.   给公式中的参数设置查询条件、过滤条件
3.   给公式中的静态参数做值设置
4.   设值运算优先级
5.   计算公式得结果



基础案例

```
{"ruleEntities":[{"name":"公式一","alias":"s1","calc":"math.sqrt(a+b)","calcParams":["a","b"],"step":false,"calcParamMappingQuery":{"a":{"signal":"sig_4","deviceId":"device_1","deviceType":"device_1","start":0,"end":9223372036854775807,"reduceTypeEnums":"AVG"},"b":{"signal":"sig_4","deviceId":"device_1","deviceType":"device_1","start":0,"end":9223372036854775807,"reduceTypeEnums":"AVG"}},"calcParamFilter":{"a":{}},"order":0},{"name":"公式2","alias":"s2","calc":"s1+1","calcParams":["s1"],"step":true,"order":1},{"name":"公式3","alias":"s3","calc":"s2+s1","calcParams":["s1","s2"],"step":true,"order":2}]}
10:49:15.309 [main] INFO com.github.huifer.hardware.sche.inf.impl.TaskServiceImpl - 求和结果= 45 , 数量 = 10 商 = 4.5000000000
10:49:15.329 [main] INFO com.github.huifer.hardware.sche.inf.impl.TaskServiceImpl - 求和结果= 45 , 数量 = 10 商 = 4.5000000000
10:49:15.344 [main] INFO com.github.huifer.hardware.sche.inf.impl.TaskServiceImpl - 求和结果= 45 , 数量 = 10 商 = 4.5000000000
10:49:15.345 [main] INFO com.github.huifer.hardware.sche.inf.impl.TaskServiceImpl - 求和结果= 45 , 数量 = 10 商 = 4.5000000000
{s3=7.0, s1=3.0, s2=4.0}
```

根据上述代码，该系统的运行流程和输出结果如下：

1.  定义了三个计算规则，分别为 "公式一"、"公式2" 和 "公式3"。
    -   "公式一" 计算 sqrt(a+b)，其中 a 和 b 分别为两个查询到的信号数据（signal 为 sig_4）的平均值。
    -   "公式2" 计算 s1+1，其中 s1 是 "公式一" 的计算结果。
    -   "公式3" 计算 s2+s1，其中 s1 和 s2 分别是 "公式一" 和 "公式2" 的计算结果。
2.  执行了四次规则计算，每次都输出 "求和结果"、"数量" 和 "商"。
    -   求和结果为 45，表示最终计算出来的所有数值之和。
    -   数量为 10，表示参与计算的数值数量。
    -   商为 4.5，表示所有数值的平均值。

最终输出的结果为一个 Map 对象，包含了 "公式一"、"公式2" 和 "公式3" 的计算结果，以及它们各自的别名 s1、s2 和 s3。



### 表结构

表名：rule_entity

| 字段名                | 数据类型                  | 说明                                     |
| --------------------- | ------------------------- | ---------------------------------------- |
| id                    | String                    | 主键                                     |
| name                  | String                    | 公式名称                                 |
| alias                 | String                    | 公式别名                                 |
| calc                  | String                    | 公式                                     |
| calcParams            | List<String>              | 公式所需参数                             |
| step                  | boolean                   | 是否为阶段运算值，如果是则需要等最后运算 |
| calcParamMappingQuery | Map<String, QueryEntity>  | key:公式中的参数，value：查询条件        |
| calcParamFilter       | Map<String, FilterEntity> | key:公式中的参数，value：过滤条件        |
| staticCalcParam       | Map<String, BigDecimal>   | 公式中的静态参数                         |
| order                 | int                       | 计算优先级，和step有关                   |

表名：calc_formula_rule

| 字段名  | 数据类型 | 说明       |
| ------- | -------- | ---------- |
| id      | String   | 主键       |
| rule_id | String   | 关联规则id |
| calc    | String   | 数学公式   |

表名：calc_formula_param_rule

| 字段名               | 数据类型       | 说明           |
| -------------------- | -------------- | -------------- |
| id                   | String         | 主键           |
| calc_formula_rule_id | String         | 关联数学公式id |
| calc_param           | String         | 公式参数       |
| ranges               | List<BigRange> | 区间           |

表名：task_entity

| 字段名   | 数据类型     | 说明       |
| -------- | ------------ | ---------- |
| id       | String       | 主键       |
| rule_ids | List<String> | 规则ID列表 |

表名：query_entity

| 字段名          | 数据类型        | 说明                 |
| --------------- | --------------- | -------------------- |
| id              | String          | 主键                 |
| signal          | String          | 信号                 |
| deviceId        | String          | 设备ID               |
| deviceType      | String          | 设备类型             |
| start           | long            | 开始时间             |
| end             | long            | 结束时间             |
| reduceTypeEnums | ReduceTypeEnums | 单个信号数据归并原则 |

**注意：开始时间，结束时间要做动态配置**



表名：filter_entity

| 字段名 | 数据类型       | 说明           |
| ------ | -------------- | -------------- |
| id     | String         | 主键           |
| ranges | List<BigRange> | 过滤器取值范围 |

表名：big_range

| 字段名 | 数据类型   | 说明       |
| ------ | ---------- | ---------- |
| id     | String     | 主键       |
| max    | BigDecimal | 区间最大值 |
| min    | BigDecimal | 区间最小值 |



## 数据计算执行器

数据计算器核心目标是和定时任务整合，通过对计算规则执行时间的配置得到具体的数据结果。

-   执行计划表(Execution Schedule)

| 字段名称       | 字段类型 | 说明               |
| -------------- | -------- | ------------------ |
| cron           | varchar  | 定时任务执行表达式 |
| rule_entity_id | varchar  | 计算规则唯一标识   |

-   执行结果存储表

| 字段名称       | 字段类型   | 说明                                                         |
| -------------- | ---------- | ------------------------------------------------------------ |
| execute_tme    | datetime   | 执行时间（注意不是程序计算的执行时间，而是cron表达式的执行时间） |
| rule_entity_id | varchar    | 计算规则唯一标识                                             |
| result         | BigDecimal | 执行结果                                                     |





## 数据展示

### 系数

将公式定时计算结果做放大或缩小，暂时仅支持乘法运算。数据放大或缩小的系数称之为K。

| 字段名称       | 字段类型   | 说明             |
| -------------- | ---------- | ---------------- |
| rule_entity_id | varchar    | 计算规则唯一标识 |
| start_time     | datetime   | k值作用开始时间  |
| end_time       | Datetime   | k值作用结束时间  |
| k              | BigDecimal | 系数             |

**时间作用范围仅对cron表达式的执行时间生效**



### 支持echart结构返回

允许查询一定时间范围内的数据将其按照echart的折线图、柱状图、饼图结构返回，并且通过参数控制是否需要配合k运算。







## 数据评级

核心功能

1.  新增评级规则：系统管理员可以在评级表中新增评级规则，包括评级名称、计算规则唯一标识、是否需要携带K系数和评级定时任务表达式等信息。
2.  管理评级层级：系统管理员可以在评级层级表中管理评级层级，包括评级主键、最大值、最小值和评级名称等信息。
3.  查看评级结果：系统管理员可以查看评级结果，包括计算规则唯一标识、评级主键、放大或缩小系数、原始计算结果、K系数结果、评级名称和执行时间等信息。
4.  自动评级：系统可以根据评级定时任务表达式自动执行评级任务，并将评级结果保存到评级结果表中。



支持数据评级，数据评级按照如下结构进行设计。

-   评级表Rating

| 字段名称       | 字段类型 | 说明               |
| -------------- | -------- | ------------------ |
| rule_entity_id | varchar  | 计算规则唯一标识   |
| name           | varchar  | 评级名称           |
| using_k        | boolean  | 是否需要携带k系数  |
| cron           | varchar  | 评级定时任务表达式 |

-   评级层级

| 字段名称  | 字段类型   | 说明     |
| --------- | ---------- | -------- |
| rating_id | varchar    | 评级主键 |
| max       | BigDecimal | 大数     |
| min       | BigDecimal | 小数     |
| name      | varchar    | 评级名称 |

**注意：max和min在使用过程中采用的是$$min<=检测值<=max$$**

-   评级结果

| 字段名称       | 字段类型   | 说明                                                         |
| -------------- | ---------- | ------------------------------------------------------------ |
| rule_entity_id | varchar    | 计算规则唯一标识                                             |
| rating_id      | varchar    | 评级主键                                                     |
| k              | BigDecimal | 放大或缩小系数                                               |
| source_data    | BigDecimal | 原始计算结果                                                 |
| calc_result    | BigDecimal | k系数结果                                                    |
| name           | varchar    | 评级                                                         |
| execute_tme    | datetime   | 执行时间（注意不是程序计算的执行时间，而是评级表cron表达式的执行时间） |





